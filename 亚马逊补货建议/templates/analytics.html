{% extends "base.html" %}

{% block title %}数据分析 - 亚马逊补货建议系统{% endblock %}

{% block content %}
<div class="row">
    <!-- 页面标题 -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-chart-line text-primary"></i> 
                数据分析报告
            </h1>
            <button class="btn btn-primary" onclick="refreshAnalytics()">
                <i class="fas fa-sync-alt"></i> 刷新分析
            </button>
        </div>
    </div>
</div>

<!-- 概览指标 -->
<div class="row mb-4" id="overviewMetrics">
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card text-center bg-primary text-white">
            <div class="card-body">
                <h4 id="totalProductsMetric">-</h4>
                <p class="mb-0">总产品数</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card text-center bg-danger text-white">
            <div class="card-body">
                <h4 id="urgentItemsMetric">-</h4>
                <p class="mb-0">紧急补货</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card text-center bg-warning text-white">
            <div class="card-body">
                <h4 id="highPriorityMetric">-</h4>
                <p class="mb-0">高优先级</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card text-center bg-success text-white">
            <div class="card-body">
                <h4 id="totalInvestmentMetric">-</h4>
                <p class="mb-0">总投资需求</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card text-center bg-info text-white">
            <div class="card-body">
                <h4 id="expectedProfitMetric">-</h4>
                <p class="mb-0">预期利润</p>
            </div>
        </div>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-6 mb-3">
        <div class="card text-center bg-secondary text-white">
            <div class="card-body">
                <h4 id="averageRoiMetric">-</h4>
                <p class="mb-0">平均ROI</p>
            </div>
        </div>
    </div>
</div>

<!-- 图表区域 -->
<div class="row">
    <!-- 库存状态分布 -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie text-primary"></i> 库存状态分布
                </h5>
            </div>
            <div class="card-body">
                <canvas id="stockStatusChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- 紧急程度分布 -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar text-warning"></i> 紧急程度分布
                </h5>
            </div>
            <div class="card-body">
                <canvas id="urgencyChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- 投资回报分析 -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-success"></i> 投资回报分析
                </h5>
            </div>
            <div class="card-body">
                <canvas id="roiChart" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- 补货优先级排行 -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-fire text-danger"></i> 补货优先级TOP10
                </h5>
            </div>
            <div class="card-body">
                <div id="topUrgentList" class="list-group list-group-flush">
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-spinner fa-spin"></i> 加载中...
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 店铺分析 -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-store text-info"></i> 店铺分析
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped" id="shopAnalysisTable">
                        <thead>
                            <tr>
                                <th>店铺名称</th>
                                <th>产品数量</th>
                                <th>紧急补货数</th>
                                <th>建议投资额</th>
                                <th>预期利润</th>
                                <th>平均ROI</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="shopAnalysisBody">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    <i class="fas fa-spinner fa-spin"></i> 正在加载数据...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 趋势分析 -->
<div class="row">
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-area text-primary"></i> 趋势分析
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4 text-center">
                        <div class="border rounded p-3">
                            <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
                            <h6>库存趋势</h6>
                            <span class="badge bg-success" id="stockTrend">稳定</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="border rounded p-3">
                            <i class="fas fa-chart-line fa-2x text-success mb-2"></i>
                            <h6>销售趋势</h6>
                            <span class="badge bg-info" id="salesTrend">增长</span>
                        </div>
                    </div>
                    <div class="col-md-4 text-center">
                        <div class="border rounded p-3">
                            <i class="fas fa-dollar-sign fa-2x text-warning mb-2"></i>
                            <h6>利润趋势</h6>
                            <span class="badge bg-warning" id="profitTrend">正向</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let stockChart = null;
let urgencyChart = null;
let roiChart = null;

/**
 * 刷新分析数据
 */
function refreshAnalytics() {
    showLoading();
    
    fetch('/api/analytics-data')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            if (data.success) {
                updateAnalytics(data.data);
            } else {
                showAlert('danger', '分析数据加载失败: ' + data.message);
            }
        })
        .catch(error => {
            hideLoading();
            showAlert('danger', '分析数据加载异常: ' + error.message);
        });
}

/**
 * 更新分析数据显示
 */
function updateAnalytics(data) {
    // 更新概览指标
    updateOverviewMetrics(data.overview || {});
    
    // 更新图表
    updateStockChart(data);
    updateUrgencyChart(data);
    updateRoiChart(data);
    
    // 更新TOP列表
    updateTopUrgentList(data.recommendations?.top_urgent_items || []);
    
    // 更新店铺分析
    updateShopAnalysis(data.categories?.by_shop || {});
    
    // 更新趋势
    updateTrends(data.trends || {});
}

/**
 * 更新概览指标
 */
function updateOverviewMetrics(overview) {
    document.getElementById('totalProductsMetric').textContent = overview.total_products || 0;
    document.getElementById('urgentItemsMetric').textContent = overview.urgent_replenishment || 0;
    document.getElementById('highPriorityMetric').textContent = overview.high_priority_items || 0;
    document.getElementById('totalInvestmentMetric').textContent = formatCurrency(overview.total_investment_needed || 0);
    document.getElementById('expectedProfitMetric').textContent = formatCurrency(overview.expected_profit || 0);
    document.getElementById('averageRoiMetric').textContent = (overview.average_roi || 0) + '%';
}

/**
 * 更新库存状态图表
 */
function updateStockChart(data) {
    const ctx = document.getElementById('stockStatusChart').getContext('2d');
    
    if (stockChart) {
        stockChart.destroy();
    }
    
    // 模拟数据
    const stockData = {
        labels: ['严重缺货', '库存偏低', '库存正常', '库存过多'],
        datasets: [{
            data: [12, 28, 45, 15],
            backgroundColor: ['#dc3545', '#ffc107', '#28a745', '#6c757d'],
            borderWidth: 2,
            borderColor: '#fff'
        }]
    };
    
    stockChart = new Chart(ctx, {
        type: 'doughnut',
        data: stockData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom'
                }
            }
        }
    });
}

/**
 * 更新紧急程度图表
 */
function updateUrgencyChart(data) {
    const ctx = document.getElementById('urgencyChart').getContext('2d');
    
    if (urgencyChart) {
        urgencyChart.destroy();
    }
    
    const urgencyData = {
        labels: ['紧急', '高', '中等', '低', '无需补货'],
        datasets: [{
            label: '产品数量',
            data: [8, 15, 22, 18, 37],
            backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#20c997', '#6c757d']
        }]
    };
    
    urgencyChart = new Chart(ctx, {
        type: 'bar',
        data: urgencyData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

/**
 * 更新ROI图表
 */
function updateRoiChart(data) {
    const ctx = document.getElementById('roiChart').getContext('2d');
    
    if (roiChart) {
        roiChart.destroy();
    }
    
    const roiData = {
        labels: ['0-20%', '20-40%', '40-60%', '60-80%', '80%+'],
        datasets: [{
            label: '投资额',
            data: [5000, 12000, 18000, 8000, 3000],
            backgroundColor: '#28a745',
            borderColor: '#1e7e34',
            borderWidth: 1
        }, {
            label: '预期利润',
            data: [800, 3600, 9000, 5600, 2400],
            backgroundColor: '#17a2b8',
            borderColor: '#138496',
            borderWidth: 1
        }]
    };
    
    roiChart = new Chart(ctx, {
        type: 'bar',
        data: roiData,
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

/**
 * 更新TOP紧急列表
 */
function updateTopUrgentList(items) {
    const container = document.getElementById('topUrgentList');
    
    if (!items || items.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">暂无紧急补货需求</div>';
        return;
    }
    
    container.innerHTML = items.slice(0, 10).map((item, index) => `
        <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
                <div class="fw-bold">${item.product_name || item.asin}</div>
                <small class="text-muted">剩余 ${item.days_of_stock} 天</small>
            </div>
            <span class="badge bg-danger rounded-pill">${Math.round(item.urgency_score)}分</span>
        </div>
    `).join('');
}

/**
 * 更新店铺分析
 */
function updateShopAnalysis(shopData) {
    const tbody = document.getElementById('shopAnalysisBody');
    
    if (!shopData || Object.keys(shopData).length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">暂无店铺数据</td></tr>';
        return;
    }
    
    tbody.innerHTML = Object.entries(shopData).map(([shopName, stats]) => `
        <tr>
            <td>${shopName}</td>
            <td>${stats.count || 0}</td>
            <td><span class="badge bg-danger">${stats.urgent || 0}</span></td>
            <td>${formatCurrency(stats.investment || 0)}</td>
            <td>${formatCurrency(stats.profit || 0)}</td>
            <td>${((stats.profit / stats.investment * 100) || 0).toFixed(1)}%</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewShopDetails('${shopName}')">
                    <i class="fas fa-eye"></i> 详情
                </button>
            </td>
        </tr>
    `).join('');
}

/**
 * 更新趋势
 */
function updateTrends(trends) {
    document.getElementById('stockTrend').textContent = trends.stock_trend || '稳定';
    document.getElementById('salesTrend').textContent = trends.sales_trend || '增长';
    document.getElementById('profitTrend').textContent = trends.profit_trend || '正向';
}

/**
 * 查看店铺详情
 */
function viewShopDetails(shopName) {
    window.location.href = `{{ url_for('replenishment_list') }}?shop_name=${encodeURIComponent(shopName)}`;
}

// 页面加载完成后自动刷新数据
document.addEventListener('DOMContentLoaded', function() {
    setTimeout(refreshAnalytics, 500);
});
</script>
{% endblock %}
