<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ” æ•°æ®å¯¹æ¯”å·¥å…· - è¡¥è´§å»ºè®®æ•°é‡éªŒè¯</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .comparison-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .data-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .quantity-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
        .difference-highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 5px;
        }
        .match-highlight {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 5px;
        }
        .manual-input {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }
        .api-data {
            background-color: #f3e5f5;
            border: 2px solid #9c27b0;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-balance-scale"></i> æ•°æ®å¯¹æ¯”å·¥å…·</h1>
                    <div>
                        <button class="btn btn-primary" onclick="loadApiData()">
                            <i class="fas fa-download"></i> è·å–APIæ•°æ®
                        </button>
                        <button class="btn btn-success" onclick="exportComparison()">
                            <i class="fas fa-file-export"></i> å¯¼å‡ºå¯¹æ¯”ç»“æœ
                        </button>
                        <a href="/" class="btn btn-secondary">
                            <i class="fas fa-home"></i> è¿”å›é¦–é¡µ
                        </a>
                    </div>
                </div>

                <!-- è¯´æ˜å¡ç‰‡ -->
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> ä½¿ç”¨è¯´æ˜</h5>
                    <p class="mb-2">æ­¤å·¥å…·ç”¨äºå¯¹æ¯”APIè·å–çš„è¡¥è´§å»ºè®®æ•°é‡ä¸é¢†æ˜ŸERPç•Œé¢æ˜¾ç¤ºçš„å®é™…æ•°é‡ï¼š</p>
                    <ol class="mb-0">
                        <li>ç‚¹å‡»"è·å–APIæ•°æ®"æŒ‰é’®è·å–ç³»ç»Ÿä¸­çš„è¡¥è´§å»ºè®®æ•°æ®</li>
                        <li>åœ¨"é¢†æ˜ŸERPå®é™…æ•°é‡"åˆ—ä¸­æ‰‹åŠ¨è¾“å…¥ä»é¢†æ˜ŸERPç•Œé¢çœ‹åˆ°çš„çœŸå®æ•°é‡</li>
                        <li>ç³»ç»Ÿä¼šè‡ªåŠ¨è®¡ç®—å·®å¼‚å¹¶é«˜äº®æ˜¾ç¤ºä¸ä¸€è‡´çš„é¡¹ç›®</li>
                        <li>å¯ä»¥å¯¼å‡ºå¯¹æ¯”ç»“æœç”¨äºè¿›ä¸€æ­¥åˆ†æ</li>
                    </ol>
                </div>

                <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h5>æ€»å¯¹æ¯”é¡¹ç›®</h5>
                                <h3 id="totalItems">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5>æ•°é‡ä¸€è‡´</h5>
                                <h3 id="matchingItems">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h5>æ•°é‡ä¸ä¸€è‡´</h5>
                                <h3 id="differentItems">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h5>å¾…éªŒè¯</h5>
                                <h3 id="pendingItems">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¯¹æ¯”æ•°æ®è¡¨æ ¼ -->
                <div class="comparison-container">
                    <h4><i class="fas fa-table"></i> è¡¥è´§å»ºè®®æ•°é‡å¯¹æ¯”</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>åºå·</th>
                                    <th>åº—é“º</th>
                                    <th>MSKU</th>
                                    <th>ASIN</th>
                                    <th class="api-data">APIæ•°æ® - é‡‡è´­å»ºè®®</th>
                                    <th class="api-data">APIæ•°æ® - æœ¬åœ°å‘FBA</th>
                                    <th class="api-data">APIæ•°æ® - æµ·å¤–å‘FBA</th>
                                    <th class="manual-input">ERPå®é™… - é‡‡è´­å»ºè®®</th>
                                    <th class="manual-input">ERPå®é™… - æœ¬åœ°å‘FBA</th>
                                    <th class="manual-input">ERPå®é™… - æµ·å¤–å‘FBA</th>
                                    <th>çŠ¶æ€</th>
                                    <th>å¤‡æ³¨</th>
                                </tr>
                            </thead>
                            <tbody id="comparisonTableBody">
                                <tr>
                                    <td colspan="12" class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> è¯·ç‚¹å‡»"è·å–APIæ•°æ®"æŒ‰é’®å¼€å§‹å¯¹æ¯”
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- å·®å¼‚åˆ†æ -->
                <div class="comparison-container" id="analysisSection" style="display: none;">
                    <h4><i class="fas fa-chart-bar"></i> å·®å¼‚åˆ†æ</h4>
                    <div id="analysisContent">
                        <!-- åŠ¨æ€ç”Ÿæˆåˆ†æå†…å®¹ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let comparisonData = [];
        let manualData = {};

        /**
         * åŠ è½½APIæ•°æ®
         */
        function loadApiData() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> åŠ è½½ä¸­...';
            btn.disabled = true;

            fetch('/api/replenishment-data?page=1&page_size=50')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        comparisonData = data.data.items || [];
                        renderComparisonTable();
                        updateStatistics();
                        showAlert('success', `æˆåŠŸåŠ è½½ ${comparisonData.length} æ¡æ•°æ®`);
                    } else {
                        showAlert('danger', 'æ•°æ®åŠ è½½å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', 'ç½‘ç»œé”™è¯¯: ' + error.message);
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        /**
         * æ¸²æŸ“å¯¹æ¯”è¡¨æ ¼
         */
        function renderComparisonTable() {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';

            comparisonData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.shop_name || 'N/A'}</td>
                    <td><code>${item.msku || 'N/A'}</code></td>
                    <td><code>${item.asin || 'N/A'}</code></td>
                    <td class="api-data quantity-display">${item.quantity_sug_purchase || 0}</td>
                    <td class="api-data quantity-display">${item.quantity_sug_local_to_fba || 0}</td>
                    <td class="api-data quantity-display">${item.quantity_sug_oversea_to_fba || 0}</td>
                    <td class="manual-input">
                        <input type="number" class="form-control form-control-sm" 
                               placeholder="è¯·è¾“å…¥" min="0" 
                               onchange="updateManualData('${item.msku}', 'purchase', this.value)">
                    </td>
                    <td class="manual-input">
                        <input type="number" class="form-control form-control-sm" 
                               placeholder="è¯·è¾“å…¥" min="0"
                               onchange="updateManualData('${item.msku}', 'local_fba', this.value)">
                    </td>
                    <td class="manual-input">
                        <input type="number" class="form-control form-control-sm" 
                               placeholder="è¯·è¾“å…¥" min="0"
                               onchange="updateManualData('${item.msku}', 'oversea_fba', this.value)">
                    </td>
                    <td id="status_${item.msku}">
                        <span class="badge bg-secondary">å¾…éªŒè¯</span>
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               placeholder="å¤‡æ³¨" 
                               onchange="updateManualData('${item.msku}', 'note', this.value)">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * æ›´æ–°æ‰‹åŠ¨è¾“å…¥æ•°æ®
         */
        function updateManualData(msku, field, value) {
            if (!manualData[msku]) {
                manualData[msku] = {};
            }
            manualData[msku][field] = value;
            
            // æ£€æŸ¥è¯¥MSKUçš„å¯¹æ¯”çŠ¶æ€
            checkComparisonStatus(msku);
            updateStatistics();
        }

        /**
         * æ£€æŸ¥å¯¹æ¯”çŠ¶æ€
         */
        function checkComparisonStatus(msku) {
            const item = comparisonData.find(i => i.msku === msku);
            const manual = manualData[msku] || {};
            const statusElement = document.getElementById(`status_${msku}`);
            
            if (!manual.purchase && !manual.local_fba && !manual.oversea_fba) {
                statusElement.innerHTML = '<span class="badge bg-secondary">å¾…éªŒè¯</span>';
                return;
            }

            const apiPurchase = item.quantity_sug_purchase || 0;
            const apiLocalFba = item.quantity_sug_local_to_fba || 0;
            const apiOverseaFba = item.quantity_sug_oversea_to_fba || 0;

            const manualPurchase = parseInt(manual.purchase || 0);
            const manualLocalFba = parseInt(manual.local_fba || 0);
            const manualOverseaFba = parseInt(manual.oversea_fba || 0);

            const purchaseDiff = apiPurchase - manualPurchase;
            const localFbaDiff = apiLocalFba - manualLocalFba;
            const overseaFbaDiff = apiOverseaFba - manualOverseaFba;

            if (purchaseDiff === 0 && localFbaDiff === 0 && overseaFbaDiff === 0) {
                statusElement.innerHTML = '<span class="badge bg-success">âœ… ä¸€è‡´</span>';
                statusElement.parentElement.parentElement.className = 'match-highlight';
            } else {
                const differences = [];
                if (purchaseDiff !== 0) differences.push(`é‡‡è´­${purchaseDiff > 0 ? '+' : ''}${purchaseDiff}`);
                if (localFbaDiff !== 0) differences.push(`æœ¬åœ°FBA${localFbaDiff > 0 ? '+' : ''}${localFbaDiff}`);
                if (overseaFbaDiff !== 0) differences.push(`æµ·å¤–FBA${overseaFbaDiff > 0 ? '+' : ''}${overseaFbaDiff}`);
                
                statusElement.innerHTML = `<span class="badge bg-warning">âš ï¸ å·®å¼‚</span><br><small>${differences.join(', ')}</small>`;
                statusElement.parentElement.parentElement.className = 'difference-highlight';
            }
        }

        /**
         * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
         */
        function updateStatistics() {
            const total = comparisonData.length;
            let matching = 0;
            let different = 0;
            let pending = 0;

            comparisonData.forEach(item => {
                const manual = manualData[item.msku] || {};
                
                if (!manual.purchase && !manual.local_fba && !manual.oversea_fba) {
                    pending++;
                    return;
                }

                const apiPurchase = item.quantity_sug_purchase || 0;
                const apiLocalFba = item.quantity_sug_local_to_fba || 0;
                const apiOverseaFba = item.quantity_sug_oversea_to_fba || 0;

                const manualPurchase = parseInt(manual.purchase || 0);
                const manualLocalFba = parseInt(manual.local_fba || 0);
                const manualOverseaFba = parseInt(manual.oversea_fba || 0);

                if (apiPurchase === manualPurchase && 
                    apiLocalFba === manualLocalFba && 
                    apiOverseaFba === manualOverseaFba) {
                    matching++;
                } else {
                    different++;
                }
            });

            document.getElementById('totalItems').textContent = total;
            document.getElementById('matchingItems').textContent = matching;
            document.getElementById('differentItems').textContent = different;
            document.getElementById('pendingItems').textContent = pending;

            // æ˜¾ç¤ºåˆ†æéƒ¨åˆ†
            if (matching > 0 || different > 0) {
                document.getElementById('analysisSection').style.display = 'block';
                generateAnalysis(matching, different, pending);
            }
        }

        /**
         * ç”Ÿæˆåˆ†ææŠ¥å‘Š
         */
        function generateAnalysis(matching, different, pending) {
            const analysisContent = document.getElementById('analysisContent');
            const total = matching + different + pending;
            const accuracy = total > 0 ? ((matching / (matching + different)) * 100).toFixed(1) : 0;

            analysisContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>ğŸ“Š å‡†ç¡®æ€§åˆ†æ</h6>
                        <p>æ•°æ®ä¸€è‡´æ€§: <strong>${accuracy}%</strong></p>
                        <p>å·²éªŒè¯é¡¹ç›®: <strong>${matching + different}/${total}</strong></p>
                    </div>
                    <div class="col-md-6">
                        <h6>ğŸ” é—®é¢˜åˆ†æ</h6>
                        ${different > 0 ? `
                        <div class="alert alert-warning">
                            <strong>å‘ç° ${different} ä¸ªæ•°é‡ä¸ä¸€è‡´çš„é¡¹ç›®</strong><br>
                            å»ºè®®æ£€æŸ¥APIæ•°æ®æºæˆ–è®¡ç®—é€»è¾‘
                        </div>
                        ` : `
                        <div class="alert alert-success">
                            <strong>æ‰€æœ‰å·²éªŒè¯é¡¹ç›®æ•°é‡ä¸€è‡´</strong><br>
                            APIæ•°æ®ä¸ERPæ•°æ®åŒ¹é…è‰¯å¥½
                        </div>
                        `}
                    </div>
                </div>
            `;
        }

        /**
         * å¯¼å‡ºå¯¹æ¯”ç»“æœ
         */
        function exportComparison() {
            const results = comparisonData.map(item => {
                const manual = manualData[item.msku] || {};
                return {
                    'åº—é“º': item.shop_name,
                    'MSKU': item.msku,
                    'ASIN': item.asin,
                    'API_é‡‡è´­å»ºè®®': item.quantity_sug_purchase || 0,
                    'API_æœ¬åœ°å‘FBA': item.quantity_sug_local_to_fba || 0,
                    'API_æµ·å¤–å‘FBA': item.quantity_sug_oversea_to_fba || 0,
                    'ERP_é‡‡è´­å»ºè®®': manual.purchase || '',
                    'ERP_æœ¬åœ°å‘FBA': manual.local_fba || '',
                    'ERP_æµ·å¤–å‘FBA': manual.oversea_fba || '',
                    'å¤‡æ³¨': manual.note || ''
                };
            });

            const csv = convertToCSV(results);
            downloadCSV(csv, 'è¡¥è´§å»ºè®®æ•°é‡å¯¹æ¯”ç»“æœ.csv');
        }

        /**
         * è½¬æ¢ä¸ºCSVæ ¼å¼
         */
        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            return csvContent;
        }

        /**
         * ä¸‹è½½CSVæ–‡ä»¶
         */
        function downloadCSV(csv, filename) {
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        /**
         * æ˜¾ç¤ºæç¤ºä¿¡æ¯
         */
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
