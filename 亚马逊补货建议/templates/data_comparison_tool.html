<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔍 数据对比工具 - 补货建议数量验证</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .comparison-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .data-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .quantity-display {
            font-size: 1.2em;
            font-weight: bold;
            color: #007bff;
        }
        .difference-highlight {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 4px;
            padding: 5px;
        }
        .match-highlight {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            padding: 5px;
        }
        .manual-input {
            background-color: #e3f2fd;
            border: 2px solid #2196f3;
        }
        .api-data {
            background-color: #f3e5f5;
            border: 2px solid #9c27b0;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1><i class="fas fa-balance-scale"></i> 数据对比工具</h1>
                    <div>
                        <button class="btn btn-primary" onclick="loadApiData()">
                            <i class="fas fa-download"></i> 获取API数据
                        </button>
                        <button class="btn btn-success" onclick="exportComparison()">
                            <i class="fas fa-file-export"></i> 导出对比结果
                        </button>
                        <a href="/" class="btn btn-secondary">
                            <i class="fas fa-home"></i> 返回首页
                        </a>
                    </div>
                </div>

                <!-- 说明卡片 -->
                <div class="alert alert-info">
                    <h5><i class="fas fa-info-circle"></i> 使用说明</h5>
                    <p class="mb-2">此工具用于对比API获取的补货建议数量与领星ERP界面显示的实际数量：</p>
                    <ol class="mb-0">
                        <li>点击"获取API数据"按钮获取系统中的补货建议数据</li>
                        <li>在"领星ERP实际数量"列中手动输入从领星ERP界面看到的真实数量</li>
                        <li>系统会自动计算差异并高亮显示不一致的项目</li>
                        <li>可以导出对比结果用于进一步分析</li>
                    </ol>
                </div>

                <!-- 统计概览 -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body text-center">
                                <h5>总对比项目</h5>
                                <h3 id="totalItems">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <h5>数量一致</h5>
                                <h3 id="matchingItems">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body text-center">
                                <h5>数量不一致</h5>
                                <h3 id="differentItems">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <h5>待验证</h5>
                                <h3 id="pendingItems">0</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 对比数据表格 -->
                <div class="comparison-container">
                    <h4><i class="fas fa-table"></i> 补货建议数量对比</h4>
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>序号</th>
                                    <th>店铺</th>
                                    <th>MSKU</th>
                                    <th>ASIN</th>
                                    <th class="api-data">API数据 - 采购建议</th>
                                    <th class="api-data">API数据 - 本地发FBA</th>
                                    <th class="api-data">API数据 - 海外发FBA</th>
                                    <th class="manual-input">ERP实际 - 采购建议</th>
                                    <th class="manual-input">ERP实际 - 本地发FBA</th>
                                    <th class="manual-input">ERP实际 - 海外发FBA</th>
                                    <th>状态</th>
                                    <th>备注</th>
                                </tr>
                            </thead>
                            <tbody id="comparisonTableBody">
                                <tr>
                                    <td colspan="12" class="text-center text-muted">
                                        <i class="fas fa-info-circle"></i> 请点击"获取API数据"按钮开始对比
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 差异分析 -->
                <div class="comparison-container" id="analysisSection" style="display: none;">
                    <h4><i class="fas fa-chart-bar"></i> 差异分析</h4>
                    <div id="analysisContent">
                        <!-- 动态生成分析内容 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let comparisonData = [];
        let manualData = {};

        /**
         * 加载API数据
         */
        function loadApiData() {
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 加载中...';
            btn.disabled = true;

            fetch('/api/replenishment-data?page=1&page_size=50')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        comparisonData = data.data.items || [];
                        renderComparisonTable();
                        updateStatistics();
                        showAlert('success', `成功加载 ${comparisonData.length} 条数据`);
                    } else {
                        showAlert('danger', '数据加载失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('danger', '网络错误: ' + error.message);
                })
                .finally(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                });
        }

        /**
         * 渲染对比表格
         */
        function renderComparisonTable() {
            const tbody = document.getElementById('comparisonTableBody');
            tbody.innerHTML = '';

            comparisonData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${item.shop_name || 'N/A'}</td>
                    <td><code>${item.msku || 'N/A'}</code></td>
                    <td><code>${item.asin || 'N/A'}</code></td>
                    <td class="api-data quantity-display">${item.quantity_sug_purchase || 0}</td>
                    <td class="api-data quantity-display">${item.quantity_sug_local_to_fba || 0}</td>
                    <td class="api-data quantity-display">${item.quantity_sug_oversea_to_fba || 0}</td>
                    <td class="manual-input">
                        <input type="number" class="form-control form-control-sm" 
                               placeholder="请输入" min="0" 
                               onchange="updateManualData('${item.msku}', 'purchase', this.value)">
                    </td>
                    <td class="manual-input">
                        <input type="number" class="form-control form-control-sm" 
                               placeholder="请输入" min="0"
                               onchange="updateManualData('${item.msku}', 'local_fba', this.value)">
                    </td>
                    <td class="manual-input">
                        <input type="number" class="form-control form-control-sm" 
                               placeholder="请输入" min="0"
                               onchange="updateManualData('${item.msku}', 'oversea_fba', this.value)">
                    </td>
                    <td id="status_${item.msku}">
                        <span class="badge bg-secondary">待验证</span>
                    </td>
                    <td>
                        <input type="text" class="form-control form-control-sm" 
                               placeholder="备注" 
                               onchange="updateManualData('${item.msku}', 'note', this.value)">
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * 更新手动输入数据
         */
        function updateManualData(msku, field, value) {
            if (!manualData[msku]) {
                manualData[msku] = {};
            }
            manualData[msku][field] = value;
            
            // 检查该MSKU的对比状态
            checkComparisonStatus(msku);
            updateStatistics();
        }

        /**
         * 检查对比状态
         */
        function checkComparisonStatus(msku) {
            const item = comparisonData.find(i => i.msku === msku);
            const manual = manualData[msku] || {};
            const statusElement = document.getElementById(`status_${msku}`);
            
            if (!manual.purchase && !manual.local_fba && !manual.oversea_fba) {
                statusElement.innerHTML = '<span class="badge bg-secondary">待验证</span>';
                return;
            }

            const apiPurchase = item.quantity_sug_purchase || 0;
            const apiLocalFba = item.quantity_sug_local_to_fba || 0;
            const apiOverseaFba = item.quantity_sug_oversea_to_fba || 0;

            const manualPurchase = parseInt(manual.purchase || 0);
            const manualLocalFba = parseInt(manual.local_fba || 0);
            const manualOverseaFba = parseInt(manual.oversea_fba || 0);

            const purchaseDiff = apiPurchase - manualPurchase;
            const localFbaDiff = apiLocalFba - manualLocalFba;
            const overseaFbaDiff = apiOverseaFba - manualOverseaFba;

            if (purchaseDiff === 0 && localFbaDiff === 0 && overseaFbaDiff === 0) {
                statusElement.innerHTML = '<span class="badge bg-success">✅ 一致</span>';
                statusElement.parentElement.parentElement.className = 'match-highlight';
            } else {
                const differences = [];
                if (purchaseDiff !== 0) differences.push(`采购${purchaseDiff > 0 ? '+' : ''}${purchaseDiff}`);
                if (localFbaDiff !== 0) differences.push(`本地FBA${localFbaDiff > 0 ? '+' : ''}${localFbaDiff}`);
                if (overseaFbaDiff !== 0) differences.push(`海外FBA${overseaFbaDiff > 0 ? '+' : ''}${overseaFbaDiff}`);
                
                statusElement.innerHTML = `<span class="badge bg-warning">⚠️ 差异</span><br><small>${differences.join(', ')}</small>`;
                statusElement.parentElement.parentElement.className = 'difference-highlight';
            }
        }

        /**
         * 更新统计信息
         */
        function updateStatistics() {
            const total = comparisonData.length;
            let matching = 0;
            let different = 0;
            let pending = 0;

            comparisonData.forEach(item => {
                const manual = manualData[item.msku] || {};
                
                if (!manual.purchase && !manual.local_fba && !manual.oversea_fba) {
                    pending++;
                    return;
                }

                const apiPurchase = item.quantity_sug_purchase || 0;
                const apiLocalFba = item.quantity_sug_local_to_fba || 0;
                const apiOverseaFba = item.quantity_sug_oversea_to_fba || 0;

                const manualPurchase = parseInt(manual.purchase || 0);
                const manualLocalFba = parseInt(manual.local_fba || 0);
                const manualOverseaFba = parseInt(manual.oversea_fba || 0);

                if (apiPurchase === manualPurchase && 
                    apiLocalFba === manualLocalFba && 
                    apiOverseaFba === manualOverseaFba) {
                    matching++;
                } else {
                    different++;
                }
            });

            document.getElementById('totalItems').textContent = total;
            document.getElementById('matchingItems').textContent = matching;
            document.getElementById('differentItems').textContent = different;
            document.getElementById('pendingItems').textContent = pending;

            // 显示分析部分
            if (matching > 0 || different > 0) {
                document.getElementById('analysisSection').style.display = 'block';
                generateAnalysis(matching, different, pending);
            }
        }

        /**
         * 生成分析报告
         */
        function generateAnalysis(matching, different, pending) {
            const analysisContent = document.getElementById('analysisContent');
            const total = matching + different + pending;
            const accuracy = total > 0 ? ((matching / (matching + different)) * 100).toFixed(1) : 0;

            analysisContent.innerHTML = `
                <div class="row">
                    <div class="col-md-6">
                        <h6>📊 准确性分析</h6>
                        <p>数据一致性: <strong>${accuracy}%</strong></p>
                        <p>已验证项目: <strong>${matching + different}/${total}</strong></p>
                    </div>
                    <div class="col-md-6">
                        <h6>🔍 问题分析</h6>
                        ${different > 0 ? `
                        <div class="alert alert-warning">
                            <strong>发现 ${different} 个数量不一致的项目</strong><br>
                            建议检查API数据源或计算逻辑
                        </div>
                        ` : `
                        <div class="alert alert-success">
                            <strong>所有已验证项目数量一致</strong><br>
                            API数据与ERP数据匹配良好
                        </div>
                        `}
                    </div>
                </div>
            `;
        }

        /**
         * 导出对比结果
         */
        function exportComparison() {
            const results = comparisonData.map(item => {
                const manual = manualData[item.msku] || {};
                return {
                    '店铺': item.shop_name,
                    'MSKU': item.msku,
                    'ASIN': item.asin,
                    'API_采购建议': item.quantity_sug_purchase || 0,
                    'API_本地发FBA': item.quantity_sug_local_to_fba || 0,
                    'API_海外发FBA': item.quantity_sug_oversea_to_fba || 0,
                    'ERP_采购建议': manual.purchase || '',
                    'ERP_本地发FBA': manual.local_fba || '',
                    'ERP_海外发FBA': manual.oversea_fba || '',
                    '备注': manual.note || ''
                };
            });

            const csv = convertToCSV(results);
            downloadCSV(csv, '补货建议数量对比结果.csv');
        }

        /**
         * 转换为CSV格式
         */
        function convertToCSV(data) {
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            return csvContent;
        }

        /**
         * 下载CSV文件
         */
        function downloadCSV(csv, filename) {
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        }

        /**
         * 显示提示信息
         */
        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
</body>
</html>
