{% extends "base.html" %}

{% block title %}系统测试 - 亚马逊补货建议系统{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- 页面标题 -->
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3">
                    <i class="fas fa-vial text-primary"></i>
                    系统测试
                </h1>
                <button class="btn btn-primary" onclick="runAllTests()">
                    <i class="fas fa-play"></i> 运行所有测试
                </button>
            </div>
        </div>
    </div>

    <!-- 测试结果卡片 -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-plug text-info"></i> API连接测试
                    </h5>
                </div>
                <div class="card-body">
                    <div id="connectionTest">
                        <p class="text-muted">点击测试按钮开始检查API连接状态</p>
                    </div>
                    <button class="btn btn-info btn-sm" onclick="testConnection()">
                        <i class="fas fa-play"></i> 测试连接
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-store text-success"></i> 店铺列表测试
                    </h5>
                </div>
                <div class="card-body">
                    <div id="shopListTest">
                        <p class="text-muted">点击测试按钮检查店铺数据获取</p>
                    </div>
                    <button class="btn btn-success btn-sm" onclick="testShopList()">
                        <i class="fas fa-play"></i> 测试店铺列表
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-boxes text-warning"></i> 补货数据测试
                    </h5>
                </div>
                <div class="card-body">
                    <div id="replenishmentTest">
                        <p class="text-muted">点击测试按钮检查补货建议数据</p>
                    </div>
                    <button class="btn btn-warning btn-sm" onclick="testReplenishmentData()">
                        <i class="fas fa-play"></i> 测试补货数据
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar text-danger"></i> 分析数据测试
                    </h5>
                </div>
                <div class="card-body">
                    <div id="analyticsTest">
                        <p class="text-muted">点击测试按钮检查数据分析功能</p>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="testAnalyticsData()">
                        <i class="fas fa-play"></i> 测试分析数据
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 测试日志 -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-terminal text-secondary"></i> 测试日志
                    </h5>
                </div>
                <div class="card-body">
                    <div id="testLog" style="height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 5px; font-family: monospace;">
                        <p class="text-muted">测试日志将在这里显示...</p>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-secondary btn-sm" onclick="clearLog()">
                            <i class="fas fa-trash"></i> 清空日志
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
/**
 * 添加日志
 */
function addLog(message, type = 'info') {
    const logDiv = document.getElementById('testLog');
    const timestamp = new Date().toLocaleTimeString();
    const colorClass = {
        'info': 'text-info',
        'success': 'text-success',
        'error': 'text-danger',
        'warning': 'text-warning'
    }[type] || 'text-dark';
    
    const logEntry = `<div class="${colorClass}">[${timestamp}] ${message}</div>`;
    logDiv.innerHTML += logEntry;
    logDiv.scrollTop = logDiv.scrollHeight;
}

/**
 * 清空日志
 */
function clearLog() {
    document.getElementById('testLog').innerHTML = '<p class="text-muted">测试日志将在这里显示...</p>';
}

/**
 * 测试API连接
 */
function testConnection() {
    addLog('开始测试API连接...', 'info');
    
    fetch('/api/test-connection')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addLog('✅ API连接测试成功', 'success');
                document.getElementById('connectionTest').innerHTML = `
                    <div class="alert alert-success">
                        <strong>连接正常</strong><br>
                        API状态: ${data.data?.api_status || 'unknown'}<br>
                        认证状态: ${data.data?.auth_status || 'unknown'}<br>
                        店铺数量: ${data.data?.shop_count || 0}
                    </div>
                `;
            } else {
                addLog('❌ API连接测试失败: ' + data.message, 'error');
                document.getElementById('connectionTest').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>连接失败</strong><br>
                        错误: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            addLog('❌ API连接测试异常: ' + error.message, 'error');
            document.getElementById('connectionTest').innerHTML = `
                <div class="alert alert-danger">
                    <strong>测试异常</strong><br>
                    错误: ${error.message}
                </div>
            `;
        });
}

/**
 * 测试店铺列表
 */
function testShopList() {
    addLog('开始测试店铺列表...', 'info');
    
    fetch('/api/shop-list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const shopCount = Array.isArray(data.data?.data) ? data.data.data.length : 0;
                addLog(`✅ 店铺列表测试成功，获取到 ${shopCount} 个店铺`, 'success');
                document.getElementById('shopListTest').innerHTML = `
                    <div class="alert alert-success">
                        <strong>获取成功</strong><br>
                        店铺数量: ${shopCount}
                    </div>
                `;
            } else {
                addLog('❌ 店铺列表测试失败: ' + data.message, 'error');
                document.getElementById('shopListTest').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>获取失败</strong><br>
                        错误: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            addLog('❌ 店铺列表测试异常: ' + error.message, 'error');
            document.getElementById('shopListTest').innerHTML = `
                <div class="alert alert-danger">
                    <strong>测试异常</strong><br>
                    错误: ${error.message}
                </div>
            `;
        });
}

/**
 * 测试补货数据
 */
function testReplenishmentData() {
    addLog('开始测试补货数据...', 'info');
    
    fetch('/api/replenishment-data?page=1&page_size=5')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const itemCount = Array.isArray(data.data) ? data.data.length : 0;
                addLog(`✅ 补货数据测试成功，获取到 ${itemCount} 条记录`, 'success');
                document.getElementById('replenishmentTest').innerHTML = `
                    <div class="alert alert-success">
                        <strong>获取成功</strong><br>
                        记录数量: ${itemCount}<br>
                        总记录数: ${data.total || 0}
                    </div>
                `;
            } else {
                addLog('❌ 补货数据测试失败: ' + data.message, 'error');
                document.getElementById('replenishmentTest').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>获取失败</strong><br>
                        错误: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            addLog('❌ 补货数据测试异常: ' + error.message, 'error');
            document.getElementById('replenishmentTest').innerHTML = `
                <div class="alert alert-danger">
                    <strong>测试异常</strong><br>
                    错误: ${error.message}
                </div>
            `;
        });
}

/**
 * 测试分析数据
 */
function testAnalyticsData() {
    addLog('开始测试分析数据...', 'info');
    
    fetch('/api/analytics-data')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const dataCount = data.data?.data?.data_count || 0;
                addLog(`✅ 分析数据测试成功，分析了 ${dataCount} 条记录`, 'success');
                document.getElementById('analyticsTest').innerHTML = `
                    <div class="alert alert-success">
                        <strong>分析成功</strong><br>
                        分析记录数: ${dataCount}<br>
                        生成时间: ${data.data?.data?.generated_at || 'unknown'}
                    </div>
                `;
            } else {
                addLog('❌ 分析数据测试失败: ' + data.message, 'error');
                document.getElementById('analyticsTest').innerHTML = `
                    <div class="alert alert-danger">
                        <strong>分析失败</strong><br>
                        错误: ${data.message}
                    </div>
                `;
            }
        })
        .catch(error => {
            addLog('❌ 分析数据测试异常: ' + error.message, 'error');
            document.getElementById('analyticsTest').innerHTML = `
                <div class="alert alert-danger">
                    <strong>测试异常</strong><br>
                    错误: ${error.message}
                </div>
            `;
        });
}

/**
 * 运行所有测试
 */
function runAllTests() {
    clearLog();
    addLog('开始运行所有测试...', 'info');
    
    // 依次运行所有测试，每个测试间隔1秒
    setTimeout(() => testConnection(), 500);
    setTimeout(() => testShopList(), 1500);
    setTimeout(() => testReplenishmentData(), 2500);
    setTimeout(() => testAnalyticsData(), 3500);
    
    setTimeout(() => {
        addLog('所有测试完成！', 'success');
    }, 4500);
}
</script>
{% endblock %}
