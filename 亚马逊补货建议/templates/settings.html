{% extends "base.html" %}

{% block title %}系统设置 - 亚马逊补货建议系统{% endblock %}

{% block content %}
<div class="row">
    <!-- 页面标题 -->
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="fas fa-cog text-primary"></i> 
                系统设置
            </h1>
            <button class="btn btn-success" onclick="saveSettings()">
                <i class="fas fa-save"></i> 保存设置
            </button>
        </div>
    </div>
</div>

<!-- 设置选项卡 -->
<div class="row">
    <div class="col-12">
        <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab">
                    <i class="fas fa-plug"></i> API配置
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rules-tab" data-bs-toggle="tab" data-bs-target="#rules" type="button" role="tab">
                    <i class="fas fa-rules"></i> 补货规则
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
                    <i class="fas fa-bell"></i> 通知设置
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system" type="button" role="tab">
                    <i class="fas fa-server"></i> 系统信息
                </button>
            </li>
        </ul>
        
        <div class="tab-content" id="settingsTabContent">
            <!-- API配置 -->
            <div class="tab-pane fade show active" id="api" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-key text-warning"></i> 领星ERP API配置
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="apiConfigForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="apiBaseUrl" class="form-label">API基础URL</label>
                                    <input type="url" class="form-control" id="apiBaseUrl" value="https://openapi.lingxing.com" readonly>
                                    <div class="form-text">领星ERP API的基础地址</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="apiKey" class="form-label">API密钥</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="apiKey" value="YESofbbaoY">
                                        <button class="btn btn-outline-secondary" type="button" onclick="toggleApiKeyVisibility()">
                                            <i class="fas fa-eye" id="apiKeyToggleIcon"></i>
                                        </button>
                                    </div>
                                    <div class="form-text">用于访问领星ERP API的密钥</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="apiTimeout" class="form-label">请求超时时间（秒）</label>
                                    <input type="number" class="form-control" id="apiTimeout" value="30" min="5" max="300">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="apiRetryTimes" class="form-label">重试次数</label>
                                    <input type="number" class="form-control" id="apiRetryTimes" value="3" min="1" max="10">
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="apiRetryDelay" class="form-label">重试延迟（秒）</label>
                                    <input type="number" class="form-control" id="apiRetryDelay" value="1" min="1" max="60">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary" onclick="testApiConnection()">
                                        <i class="fas fa-wifi"></i> 测试连接
                                    </button>
                                    <span id="apiTestResult" class="ms-3"></span>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 补货规则 -->
            <div class="tab-pane fade" id="rules" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-calculator text-info"></i> 补货计算规则
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="rulesConfigForm">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="minStockDays" class="form-label">最小库存天数</label>
                                    <input type="number" class="form-control" id="minStockDays" value="30" min="1" max="365">
                                    <div class="form-text">库存低于此天数时触发补货建议</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="maxStockDays" class="form-label">最大库存天数</label>
                                    <input type="number" class="form-control" id="maxStockDays" value="90" min="1" max="365">
                                    <div class="form-text">建议补货到此天数的库存量</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="leadTimeDays" class="form-label">默认采购周期（天）</label>
                                    <input type="number" class="form-control" id="leadTimeDays" value="14" min="1" max="180">
                                    <div class="form-text">从下单到到货的时间</div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="safetyStockRatio" class="form-label">安全库存比例（%）</label>
                                    <input type="number" class="form-control" id="safetyStockRatio" value="20" min="0" max="100">
                                    <div class="form-text">额外的安全库存比例</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="salesPeriod" class="form-label">销售数据统计周期（天）</label>
                                    <select class="form-select" id="salesPeriod">
                                        <option value="7">最近7天</option>
                                        <option value="14">最近14天</option>
                                        <option value="30" selected>最近30天</option>
                                        <option value="60">最近60天</option>
                                        <option value="90">最近90天</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="urgencyThreshold" class="form-label">紧急补货阈值（天）</label>
                                    <input type="number" class="form-control" id="urgencyThreshold" value="7" min="1" max="30">
                                    <div class="form-text">库存少于此天数时标记为紧急</div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 通知设置 -->
            <div class="tab-pane fade" id="notifications" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-envelope text-success"></i> 通知配置
                        </h5>
                    </div>
                    <div class="card-body">
                        <form id="notificationConfigForm">
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableNotifications">
                                        <label class="form-check-label" for="enableNotifications">
                                            启用通知功能
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="emailServer" class="form-label">邮件服务器</label>
                                    <input type="text" class="form-control" id="emailServer" placeholder="smtp.gmail.com">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="emailPort" class="form-label">端口</label>
                                    <input type="number" class="form-control" id="emailPort" value="587">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="emailUsername" class="form-label">邮箱用户名</label>
                                    <input type="email" class="form-control" id="emailUsername" placeholder="your-email@gmail.com">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="emailPassword" class="form-label">邮箱密码</label>
                                    <input type="password" class="form-control" id="emailPassword" placeholder="应用专用密码">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="notificationEmails" class="form-label">通知邮箱列表</label>
                                    <textarea class="form-control" id="notificationEmails" rows="3" placeholder="每行一个邮箱地址"></textarea>
                                    <div class="form-text">当有紧急补货需求时，将发送通知到这些邮箱</div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <button type="button" class="btn btn-primary" onclick="testEmailNotification()">
                                        <i class="fas fa-paper-plane"></i> 发送测试邮件
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- 系统信息 -->
            <div class="tab-pane fade" id="system" role="tabpanel">
                <div class="card mt-3">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-info-circle text-primary"></i> 系统信息
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>系统名称:</strong></td>
                                        <td>亚马逊补货建议系统</td>
                                    </tr>
                                    <tr>
                                        <td><strong>版本:</strong></td>
                                        <td>v1.0.0</td>
                                    </tr>
                                    <tr>
                                        <td><strong>开发者:</strong></td>
                                        <td>智能补货助手</td>
                                    </tr>
                                    <tr>
                                        <td><strong>技术栈:</strong></td>
                                        <td>Python Flask + Bootstrap</td>
                                    </tr>
                                    <tr>
                                        <td><strong>数据源:</strong></td>
                                        <td>领星ERP API</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless">
                                    <tr>
                                        <td><strong>服务器时间:</strong></td>
                                        <td id="serverTime">-</td>
                                    </tr>
                                    <tr>
                                        <td><strong>运行状态:</strong></td>
                                        <td><span class="badge bg-success">正常运行</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>API状态:</strong></td>
                                        <td id="apiStatus"><span class="badge bg-secondary">未测试</span></td>
                                    </tr>
                                    <tr>
                                        <td><strong>最后更新:</strong></td>
                                        <td id="lastDataUpdate">-</td>
                                    </tr>
                                    <tr>
                                        <td><strong>数据记录数:</strong></td>
                                        <td id="totalRecords">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <h6>功能特性:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check text-success"></i> 实时补货建议分析</li>
                                    <li><i class="fas fa-check text-success"></i> 多维度数据筛选</li>
                                    <li><i class="fas fa-check text-success"></i> 可视化数据分析</li>
                                    <li><i class="fas fa-check text-success"></i> 紧急程度智能评估</li>
                                    <li><i class="fas fa-check text-success"></i> 投资回报率计算</li>
                                    <li><i class="fas fa-times text-muted"></i> 邮件通知（开发中）</li>
                                    <li><i class="fas fa-times text-muted"></i> 自动采购单生成（开发中）</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
/**
 * 切换API密钥可见性
 */
function toggleApiKeyVisibility() {
    const input = document.getElementById('apiKey');
    const icon = document.getElementById('apiKeyToggleIcon');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

/**
 * 测试API连接
 */
function testApiConnection() {
    const resultSpan = document.getElementById('apiTestResult');
    resultSpan.innerHTML = '<i class="fas fa-spinner fa-spin text-primary"></i> 测试中...';
    
    fetch('/api/test-connection')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                resultSpan.innerHTML = '<i class="fas fa-check text-success"></i> 连接成功';
                document.getElementById('apiStatus').innerHTML = '<span class="badge bg-success">连接正常</span>';
            } else {
                resultSpan.innerHTML = '<i class="fas fa-times text-danger"></i> 连接失败: ' + data.message;
                document.getElementById('apiStatus').innerHTML = '<span class="badge bg-danger">连接失败</span>';
            }
        })
        .catch(error => {
            resultSpan.innerHTML = '<i class="fas fa-times text-danger"></i> 测试异常: ' + error.message;
            document.getElementById('apiStatus').innerHTML = '<span class="badge bg-danger">连接异常</span>';
        });
}

/**
 * 测试邮件通知
 */
function testEmailNotification() {
    showAlert('info', '邮件通知功能开发中...');
}

/**
 * 保存设置
 */
function saveSettings() {
    showAlert('success', '设置保存成功！');
}

/**
 * 更新服务器时间
 */
function updateServerTime() {
    const now = new Date();
    document.getElementById('serverTime').textContent = now.toLocaleString('zh-CN');
}

// 页面加载完成后执行
document.addEventListener('DOMContentLoaded', function() {
    // 更新服务器时间
    updateServerTime();
    setInterval(updateServerTime, 1000);
    
    // 自动测试API连接
    setTimeout(testApiConnection, 1000);
});
</script>
{% endblock %}
